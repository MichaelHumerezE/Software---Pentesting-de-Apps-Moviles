<?php

namespace App\Http\Controllers;

use Exception;
use Illuminate\Http\Request;
use GuzzleHttp\Client;

class AnalisisEstaticoController extends Controller
{
    private $apiKey;
    private $url;

    function __construct()
    {
        $apiKey = "1ee792efbe85b608c34450baa48c2df1e42e54726beb3c7200b6e41cb898d798";
        $url = "http://localhost:8000/";
    }

    public function indexApk(Request $request)
    {
        return view('administrador.analisis_estatico.subir_apk');
    }

    public function indexResultados(Request $request)
    {
        $file = $request->file('apk');
        $fileName = $file->getClientOriginalName();

        // Mueve el archivo a la carpeta 'public/uploads'
        $file->move(public_path('uploads'), $fileName);

        // Obtiene la direcciÃ³n completa del archivo
        $filePath = public_path('uploads/' . $fileName);
        // Cree una instancia de Guzzle
        $client = new Client();

        // Realice una solicitud POST a la API REST de MobSF para subir el archivo
        $response = $client->post(
            'http://localhost:8000/api/v1/upload',
            [
                'headers' => [
                    'Authorization' => '85b655843928a5ffd05139fe296bbf522ea745df6c1b3c120164829252fa9a34',
                ],
                'multipart' => [
                    [
                        'name' => 'file',
                        'contents' => fopen($filePath, 'r'),
                    ],
                ],
            ]
        );

        // Verifique la respuesta
        if ($response->getStatusCode() !== 200) {
            throw new Exception('Error al subir el archivo');
        }

        // Obtenga el hash del archivo
        $hash = json_decode($response->getBody())->hash;

        return response()->json(['hash' => $hash]);
        //return view('administrador.analisis_estatico.subir_apk', ['report' => $report]);
    }

    public function showDetailsCode()
    {
        return view('administrador.analisis_estatico.detalle_codigo');
    }
}
